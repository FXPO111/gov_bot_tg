from __future__ import annotations

from telegram import InlineKeyboardButton, InlineKeyboardMarkup

TG_MSG_LIMIT = 3800

# –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–º—ã –∫–∞–∫ –ù–ï–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å (–¥–ª—è —Ç–µ—Ö, –∫–æ–º—É –ø—Ä–æ—â–µ –≤—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é),
# –Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–π UX ‚Äî –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
TOPIC_HINTS: dict[str, tuple[str, list[str]]] = {
    "credit": (
        "–ö—Ä–µ–¥–∏—Ç–∏/–±–æ—Ä–≥–∏",
        [
            "–•—Ç–æ –∫—Ä–µ–¥–∏—Ç–æ—Ä –∞–±–æ –∫–æ–º—É –≤–∏ –≤–∏–Ω–Ω—ñ?",
            "–î–∞—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä—É/—Ä–æ–∑–ø–∏—Å–∫–∏ —Ç–∞ —Å—É–º–∞ –±–æ—Ä–≥—É.",
            "–ß–∏ —î –≥—Ä–∞—Ñ—ñ–∫ –ø–ª–∞—Ç–µ–∂—ñ–≤ —ñ –ø—Ä–æ—Å—Ç—Ä–æ—á–∫–∞?",
            "–Ø–∫—ñ —à—Ç—Ä–∞—Ñ–∏/–ø–µ–Ω—è –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω—ñ?",
            "–ß–∏ –±—É–ª–∏ –≤–∏–º–æ–≥–∏, –¥–∑–≤—ñ–Ω–∫–∏, –ª–∏—Å—Ç–∏ –∞–±–æ —Å—É–¥?",
            "–Ø–∫—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏ —É –≤–∞—Å –Ω–∞ —Ä—É–∫–∞—Ö?",
        ],
    ),
    "fines": (
        "–®—Ç—Ä–∞—Ñ–∏/–ø–æ–ª—ñ—Ü—ñ—è",
        [
            "–•—Ç–æ —Å–∫–ª–∞–≤ –ø–æ—Å—Ç–∞–Ω–æ–≤—É –∞–±–æ –ø—Ä–æ—Ç–æ–∫–æ–ª?",
            "–î–∞—Ç–∞, –º—ñ—Å—Ü–µ —Ç–∞ —Å—É—Ç—å –ø–æ—Ä—É—à–µ–Ω–Ω—è.",
            "–ù–æ–º–µ—Ä –ø–æ—Å—Ç–∞–Ω–æ–≤–∏/–ø—Ä–æ—Ç–æ–∫–æ–ª—É.",
            "–Ø–∫–∏–π —Å—Ç—Ä–æ–∫ –æ—Å–∫–∞—Ä–∂–µ–Ω–Ω—è –∑–∞–ª–∏—à–∏–≤—Å—è?",
            "–ß–∏ —î —Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ –∞–±–æ —Å–≤—ñ–¥–∫–∏?",
            "–Ø–∫—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏ –≤–∂–µ –æ—Ç—Ä–∏–º–∞–ª–∏/–ø–æ–¥–∞–ª–∏?",
        ],
    ),
    "work": (
        "–†–æ–±–æ—Ç–∞",
        [
            "–•—Ç–æ —Ä–æ–±–æ—Ç–æ–¥–∞–≤–µ—Ü—å —ñ —è–∫–∞ –ø–æ—Å–∞–¥–∞?",
            "–©–æ —Å—Ç–∞–ª–æ—Å—è: –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è, –±–æ—Ä–≥ –ø–æ –∑–∞—Ä–ø–ª–∞—Ç—ñ, —ñ–Ω—à–µ?",
            "–ö–æ–ª–∏ —Ü–µ —Å—Ç–∞–ª–æ—Å—è —Ç–∞ —è–∫—ñ –±—É–ª–∏ –Ω–∞–∫–∞–∑–∏/–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è?",
            "–Ø–∫—ñ —Å—É–º–∏ –∑–∞–±–æ—Ä–≥–æ–≤–∞–Ω–æ—Å—Ç—ñ –∞–±–æ –≤–∏–ø–ª–∞—Ç?",
            "–ß–∏ —î —Ç—Ä—É–¥–æ–≤–∏–π –¥–æ–≥–æ–≤—ñ—Ä, –Ω–∞–∫–∞–∑–∏, –ø–µ—Ä–µ–ø–∏—Å–∫–∞?",
            "–ß–∏ –∑–≤–µ—Ä—Ç–∞–ª–∏—Å—è –¥–æ —Ä–æ–±–æ—Ç–æ–¥–∞–≤—Ü—è –ø–∏—Å—å–º–æ–≤–æ?",
        ],
    ),
    "family": (
        "–°—ñ–º‚Äô—è",
        [
            "–©–æ —Å–∞–º–µ: –∞–ª—ñ–º–µ–Ω—Ç–∏, —Ä–æ–∑–ª—É—á–µ–Ω–Ω—è, –º—ñ—Å—Ü–µ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è –¥–∏—Ç–∏–Ω–∏?",
            "–•—Ç–æ —É—á–∞—Å–Ω–∏–∫–∏ —Ç–∞ –≤—ñ–∫ –¥—ñ—Ç–µ–π (—è–∫—â–æ —î)?",
            "–ß–∏ —î —à–ª—é–±/—Ä–æ–∑–ª—É—á–µ–Ω–Ω—è –æ—Ñ—ñ—Ü—ñ–π–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ?",
            "–Ø–∫—ñ –¥–æ—Ö–æ–¥–∏ —Ç–∞ –≤–∏—Ç—Ä–∞—Ç–∏ –≤–∞–∂–ª–∏–≤—ñ –¥–ª—è —Å–ø—Ä–∞–≤–∏?",
            "–ß–∏ –±—É–ª–∏ –¥–æ–º–æ–≤–ª–µ–Ω–æ—Å—Ç—ñ –∞–±–æ —Ä—ñ—à–µ–Ω–Ω—è —Å—É–¥—É —Ä–∞–Ω—ñ—à–µ?",
            "–Ø–∫—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏ –≤–∂–µ —î?",
        ],
    ),
    "realty": (
        "–ù–µ—Ä—É—Ö–æ–º—ñ—Å—Ç—å",
        [
            "–ü—Ä–æ —â–æ —Å–ø—ñ—Ä: –∫—É–ø—ñ–≤–ª—è, –æ—Ä–µ–Ω–¥–∞, –≤–∏—Å–µ–ª–µ–Ω–Ω—è, –ø—Ä–∞–≤–æ –≤–ª–∞—Å–Ω–æ—Å—Ç—ñ?",
            "–ê–¥—Ä–µ—Å–∞ –æ–±‚Äô—î–∫—Ç–∞ —Ç–∞ —Ö—Ç–æ –≤–ª–∞—Å–Ω–∏–∫ –∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏?",
            "–Ø–∫—ñ –¥–æ–≥–æ–≤–æ—Ä–∏ –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ —Ç–∞ –∫–æ–ª–∏?",
            "–ß–∏ –±—É–ª–∏ –ø–ª–∞—Ç–µ–∂—ñ/–±–æ—Ä–≥–∏ –ø–æ –∫–æ–º—É–Ω–∞–ª—å–Ω–∏—Ö?",
            "–ß–∏ —î —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ–π–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏, –≤–∏—Ç—è–≥, —Ç–µ—Ö–ø–∞—Å–ø–æ—Ä—Ç?",
            "–ß–∏ —î –ø—Ä–µ—Ç–µ–Ω–∑—ñ—ó –∞–±–æ —Å—É–¥–æ–≤—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏?",
        ],
    ),
    "inherit": (
        "–°–ø–∞–¥—â–∏–Ω–∞",
        [
            "–•—Ç–æ —Å–ø–∞–¥–∫–æ–¥–∞–≤–µ—Ü—å —ñ –¥–∞—Ç–∞ —Å–º–µ—Ä—Ç—ñ?",
            "–Ø–∫–µ –º–∞–π–Ω–æ –≤—Ö–æ–¥–∏—Ç—å —É —Å–ø–∞–¥—â–∏–Ω—É?",
            "–Ø–∫–∏–π –≤–∞—à —Ä–æ–¥–∏–Ω–Ω–∏–π –∑–≤‚Äô—è–∑–æ–∫?",
            "–ß–∏ —î –∑–∞–ø–æ–≤—ñ—Ç?",
            "–ß–∏ –ø–æ–¥–∞–≤–∞–ª–∏ –∑–∞—è–≤—É –Ω–æ—Ç–∞—Ä—ñ—É—Å—É —Ç–∞ –∫–æ–ª–∏?",
            "–Ø–∫—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∂–µ –º–∞—î—Ç–µ?",
        ],
    ),
    "other": (
        "–Ü–Ω—à–µ",
        [
            "–ö–æ—Ä–æ—Ç–∫–æ: —â–æ —Å—Ç–∞–ª–æ—Å—è —ñ —Ö—Ç–æ —É—á–∞—Å–Ω–∏–∫–∏?",
            "–ö–æ–ª–∏ —Ç–∞ –¥–µ —Ü–µ —Å—Ç–∞–ª–æ—Å—è?",
            "–Ø–∫—ñ —Å—É–º–∏ –∞–±–æ –≤—Ç—Ä–∞—Ç–∏ –≤–∞–∂–ª–∏–≤—ñ?",
            "–Ø–∫—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏/–¥–æ–∫–∞–∑–∏ –≤–∂–µ —î?",
            "–©–æ –≤–∏ –≤–∂–µ —Ä–æ–±–∏–ª–∏ –¥–ª—è –≤–∏—Ä—ñ—à–µ–Ω–Ω—è?",
            "–Ø–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω?",
        ],
    ),
}


def main_menu_markup() -> InlineKeyboardMarkup:
    # –î–ª—è ‚Äú–∞–Ω–∞–ª–æ–≥–æ–≤–∏—Ö‚Äù: –º–∏–Ω–∏–º—É–º –≤—ã–±–æ—Ä–∞ + –ø–æ–Ω—è—Ç–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è.
    return InlineKeyboardMarkup(
        [
            [InlineKeyboardButton("üìå –Ø–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç–∏", callback_data="main:template")],
            [InlineKeyboardButton("üìö –©–æ —Ç–∞–∫–µ ¬´–¥–∂–µ—Ä–µ–ª–∞¬ª", callback_data="main:sources_info")],
            [InlineKeyboardButton("üìå –û–±—Ä–∞—Ç–∏ —Ç–µ–º—É (–Ω–µ–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ)", callback_data="main:topics")],
            [InlineKeyboardButton("üÜï –ù–æ–≤–µ –ø–∏—Ç–∞–Ω–Ω—è", callback_data="main:newq")],
        ]
    )


def topics_markup() -> InlineKeyboardMarkup:
    rows = [[InlineKeyboardButton(name, callback_data=f"topic:{key}")] for key, (name, _) in TOPIC_HINTS.items()]
    return InlineKeyboardMarkup(rows)


def case_markup(has_draft: bool) -> InlineKeyboardMarkup:
    # –í–≤–æ–¥ –æ–±—ã—á–Ω–æ –∏–¥–µ—Ç —Ç–µ–∫—Å—Ç–æ–º (auto-analyze), –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏.
    rows: list[list[InlineKeyboardButton]] = []
    if has_draft:
        rows.append([InlineKeyboardButton("‚úÖ –ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏", callback_data="case:analyze")])
        rows.append([InlineKeyboardButton("üóë –û—á–∏—Å—Ç–∏—Ç–∏", callback_data="case:clear")])
    rows.append([InlineKeyboardButton("üÜï –ù–æ–≤–µ –ø–∏—Ç–∞–Ω–Ω—è", callback_data="main:newq")])
    return InlineKeyboardMarkup(rows)


def answer_markup(has_sources: bool, show_full_button: bool) -> InlineKeyboardMarkup:
    rows: list[list[InlineKeyboardButton]] = []
    if has_sources:
        rows.append([InlineKeyboardButton("üìö –î–∂–µ—Ä–µ–ª–∞", callback_data="ans:sources")])
    if show_full_button:
        rows.append([InlineKeyboardButton("‚¨áÔ∏è –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤–Ω—ñ—Å—Ç—é", callback_data="ans:toggle_full")])
    rows.append([InlineKeyboardButton("üÜï –ù–æ–≤–µ –ø–∏—Ç–∞–Ω–Ω—è", callback_data="main:newq")])
    return InlineKeyboardMarkup(rows)


def need_more_markup() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup([[InlineKeyboardButton("üÜï –ù–æ–≤–µ –ø–∏—Ç–∞–Ω–Ω—è", callback_data="main:newq")]])


def sources_markup() -> InlineKeyboardMarkup:
    # –í –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö –ù–ï–õ–¨–ó–Ø –¥–æ–±–∞–≤–ª—è—Ç—å –∫–Ω–æ–ø–∫—É "–î–∂–µ—Ä–µ–ª–∞" (–∏–Ω–∞—á–µ loop).
    return InlineKeyboardMarkup(
        [
            [InlineKeyboardButton("‚¨ÖÔ∏è –î–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ", callback_data="ans:back")],
            [InlineKeyboardButton("üÜï –ù–æ–≤–µ –ø–∏—Ç–∞–Ω–Ω—è", callback_data="main:newq")],
        ]
    )


def template_text() -> str:
    return (
        "1) –©–æ —Å—Ç–∞–ª–æ—Å—è (1‚Äì2 —Ä–µ—á–µ–Ω–Ω—è):\n"
        "2) –•—Ç–æ —É—á–∞—Å–Ω–∏–∫–∏:\n"
        "3) –ö–æ–ª–∏ —ñ –¥–µ —Ü–µ —Å—Ç–∞–ª–æ—Å—è:\n"
        "4) –°—É–º–∏/–∑–±–∏—Ç–∫–∏ (—è–∫—â–æ —î):\n"
        "5) –Ø–∫—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏ —î:\n"
        "6) –©–æ –≤–∂–µ —Ä–æ–±–∏–ª–∏:\n"
        "7) –Ø–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω:"
    )


def format_sources(citations: list[dict]) -> str:
    blocks: list[str] = []
    for c in (citations or [])[:6]:
        n = c.get("n")
        title = c.get("title") or "–î–∂–µ—Ä–µ–ª–æ"
        heading = c.get("heading") or c.get("path") or ""
        url = c.get("url") or ""

        line = f"[{n}] {title}" if n is not None else title
        if heading:
            line += f" ‚Äî {heading}"
        if url:
            line += f"\n{url}"
        blocks.append(line)

    return "\n\n".join(blocks) if blocks else "–î–∂–µ—Ä–µ–ª–∞ –≤—ñ–¥—Å—É—Ç–Ω—ñ."


def format_questions(questions: list[str]) -> str:
    """
    –í–∞–∂–Ω–æ: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ 3 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–µ–ª–∞–µ–º –ù–ï –∑–¥–µ—Å—å, –∞ –≤ handlers.py –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–µ,
    —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä –æ—Å—Ç–∞–≤–∞–ª—Å—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º.
    """
    clean = [str(q).strip() for q in (questions or [])[:8] if str(q).strip()]
    return "\n".join(f"‚Ä¢ {q}" for q in clean) if clean else ""


def trim_answer_ex(text: str) -> tuple[str, bool]:
    """
    –û–±—Ä–µ–∑–∞–µ–º –¥–æ 3000 —Å–∏–º–≤–æ–ª–æ–≤, —á—Ç–æ–±—ã:
    - –æ—Å—Ç–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ –ø–æ–¥ —Ñ—É—Ç–µ—Ä
    - –Ω–µ —É–ø–∏—Ä–∞—Ç—å—Å—è –≤ TG_MSG_LIMIT (3800) –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–Ω–æ–ø–æ–∫/–ø–æ–¥–ø–∏—Å–µ–π
    """
    t = (text or "").strip()
    if len(t) <= 3000:
        return t, False
    return t[:3000].rstrip() + "\n\n‚Ä¶", True
